<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Pi Cycle Top Indicator</title>
    
    <!-- PWA Support f√ºr Mobile App -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="BTC Pi Cycle">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#f7931a">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: #ffffff;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #f7931a;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(247, 147, 26, 0.3);
        }

        .last-updated {
            color: #888;
            font-size: 0.9rem;
        }

        .indicator-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .value-card {
            background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .value-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5);
        }

        .value-card h3 {
            color: #ccc;
            font-size: 1rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .value-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #f7931a;
            margin-bottom: 10px;
        }

        .value-card .change {
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .change.positive { color: #4caf50; }
        .change.negative { color: #f44336; }

        .value-card .description {
            color: #888;
            font-size: 0.85rem;
            margin-top: 8px;
        }

        .signal-card {
            border: 2px solid #f7931a;
        }

        .signal {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .signal-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4caf50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
            transition: all 0.3s ease;
        }

        .signal-indicator.warning {
            background: #ff9800;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
        }

        .signal-indicator.bearish {
            background: #f44336;
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.5);
        }

        .chart-container {
            background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .timeframe-buttons {
            display: flex;
            gap: 5px;
        }

        .timeframe-btn {
            background: #333;
            color: #ccc;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .timeframe-btn:hover {
            background: #444;
            color: #fff;
        }

        .timeframe-btn.active {
            background: #f7931a;
            color: #000;
        }

        .chart-wrapper {
            position: relative;
            height: 500px;
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
        }

        .status-notice {
            background: #4caf50;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .status-notice.loading {
            background: #ff9800;
            color: #000;
        }

        .status-notice.error {
            background: #f44336;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top: 3px solid #f7931a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            padding: 20px;
            border-top: 1px solid #333;
            color: #888;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header h1 { font-size: 2rem; }
            .indicator-values { grid-template-columns: 1fr; gap: 15px; }
            .chart-wrapper { height: 400px; }
            .chart-controls { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p>Lade echte Bitcoin-Daten von 2016 bis heute...</p>
    </div>

    <div class="container">
        <header class="header">
            <h1>Bitcoin Pi Cycle Top Indicator</h1>
            <div class="last-updated">
                <span id="lastUpdate">Lade Daten...</span>
            </div>
        </header>

        <div class="status-notice loading" id="statusNotice">
            Lade tagesaktuelle Bitcoin-Daten von 2016 bis heute...
        </div>

        <div class="indicator-values">
            <div class="value-card">
                <h3>Bitcoin Preis</h3>
                <div class="value" id="bitcoinPrice">$--</div>
                <div class="change" id="priceChange">--</div>
                <div class="description">Aktueller BTC/USD Kurs</div>
            </div>
            <div class="value-card">
                <h3>111-Tage MA</h3>
                <div class="value" id="ma111">$--</div>
                <div class="description">111-Tage gleitender Durchschnitt</div>
            </div>
            <div class="value-card">
                <h3>350-Tage MA √ó 2</h3>
                <div class="value" id="ma350x2">$--</div>
                <div class="description">350-Tage MA multipliziert mit 2</div>
            </div>
            <div class="value-card signal-card">
                <h3>Pi Cycle Signal</h3>
                <div class="signal" id="piSignal">
                    <div class="signal-indicator" id="signalIndicator"></div>
                    <span id="signalText">Berechne...</span>
                </div>
                <div class="description">
                    Abstand: <span id="signalDistance">--</span><br>
                    √Ñnderung zu gestern: <span id="dailyChange">--</span>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-controls">
                <div class="timeframe-buttons">
                    <button class="timeframe-btn" data-period="180">6M</button>
                    <button class="timeframe-btn" data-period="365">1Y</button>
                    <button class="timeframe-btn" data-period="730">2Y</button>
                    <button class="timeframe-btn" data-period="1095">3Y</button>
                    <button class="timeframe-btn active" data-period="3287">Alle (seit 2016)</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h2 style="color: #f7931a; text-align: center; margin-bottom: 20px;">Bitcoin Rainbow Chart</h2>
            <div class="chart-wrapper">
                <canvas id="rainbowChart"></canvas>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: #222; border-radius: 8px;">
                <p style="color: #ccc; font-size: 0.9rem; margin: 0;">
                    <strong>Rainbow Chart Legende:</strong><br>
                    üî¥ <span style="color: #FF0000;">Maximale Blase</span> |
                    üü† <span style="color: #FF6100;">FOMO √ºberkauft</span> |
                    üü° <span style="color: #FFC300;">Sehr √ºberkauft</span> |
                    üü¢ <span style="color: #52FF00;">Fair Value</span> |
                    üîµ <span style="color: #00D4FF;">√úberverkauft</span> |
                    üü£ <span style="color: #0062FF;">Extremer Ausverkauf</span>
                </p>
            </div>
        </div>

        <footer class="footer">
            <p>Echte Daten von Yahoo Finance | Dies ist keine Finanzberatung</p>
        </footer>
    </div>

    <script>
        class BitcoinPiCycleApp {
            constructor() {
                this.chart = null;
                this.rainbowChart = null;
                this.priceData = [];
                this.currentPeriod = 3287; // Default: Alle Daten seit 2016
                this.isUsingLiveData = false;
                this.previousDistance = null;
                
                this.initializeApp();
            }

            async initializeApp() {
                console.log('Bitcoin Pi Cycle App wird gestartet...');
                this.setupEventListeners();
                await this.loadRealBitcoinData();
                this.hideLoading();
                console.log('App erfolgreich geladen!');
            }

            setupEventListeners() {
                // Timeframe buttons
                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentPeriod = parseInt(e.target.dataset.period);
                        this.updateChart();
                    });
                });
            }

            async loadRealBitcoinData() {
                this.updateStatus('Lade echte Bitcoin-Daten von Yahoo Finance...', 'loading');
                
                try {
                    // Yahoo Finance ist sehr zuverl√§ssig f√ºr historische Daten
                    const response = await fetch('https://query1.finance.yahoo.com/v8/finance/chart/BTC-USD?period1=1451606400&period2=' + Math.floor(Date.now()/1000) + '&interval=1d&includePrePost=true&events=div%7Csplit');
                    
                    if (!response.ok) {
                        throw new Error('Yahoo Finance API nicht verf√ºgbar');
                    }
                    
                    const data = await response.json();
                    
                    if (!data.chart || !data.chart.result || !data.chart.result[0]) {
                        throw new Error('Ung√ºltige Datenstruktur von Yahoo Finance');
                    }
                    
                    this.processYahooFinanceData(data.chart.result[0]);
                    this.isUsingLiveData = true;
                    this.updateStatus('‚úÖ Echte Bitcoin-Daten von 2016 bis heute erfolgreich geladen!', 'success');
                    
                    setTimeout(() => {
                        const notice = document.getElementById('statusNotice');
                        if (notice) notice.style.display = 'none';
                    }, 4000);
                    
                } catch (error) {
                    console.warn('Yahoo Finance fehlgeschlagen, versuche alternative Methode:', error);
                    await this.loadFromAlternativeSource();
                }
            }

            async loadFromAlternativeSource() {
                this.updateStatus('Versuche CryptoCompare API...', 'loading');
                
                try {
                    // CryptoCompare f√ºr historische Daten
                    const promises = [];
                    const currentTime = Math.floor(Date.now() / 1000);
                    
                    // Lade Daten in Chunks (CryptoCompare hat 2000 Datenpunkt-Limit)
                    for (let i = 0; i < 5; i++) {
                        const toTs = currentTime - (i * 2000 * 24 * 60 * 60); // 2000 Tage zur√ºck
                        promises.push(
                            fetch(`https://min-api.cryptocompare.com/data/v2/histoday?fsym=BTC&tsym=USD&toTs=${toTs}&limit=2000`)
                                .then(res => res.json())
                        );
                    }
                    
                    const results = await Promise.all(promises);
                    
                    // Kombiniere alle Daten
                    let allData = [];
                    results.forEach(result => {
                        if (result.Data && result.Data.Data) {
                            allData = allData.concat(result.Data.Data);
                        }
                    });
                    
                    // Sortiere nach Zeit und entferne Duplikate
                    allData.sort((a, b) => a.time - b.time);
                    const uniqueData = allData.filter((item, index, arr) => 
                        index === 0 || item.time !== arr[index - 1].time
                    );
                    
                    // Filtere nur Daten ab 2016
                    const since2016 = uniqueData.filter(item => item.time >= 1451606400); // 1. Januar 2016
                    
                    if (since2016.length > 100) {
                        this.processCryptoCompareData(since2016);
                        this.isUsingLiveData = true;
                        this.updateStatus('‚úÖ Echte Bitcoin-Daten seit 2016 von CryptoCompare geladen!', 'success');
                        
                        setTimeout(() => {
                            const notice = document.getElementById('statusNotice');
                            if (notice) notice.style.display = 'none';
                        }, 4000);
                    } else {
                        throw new Error('Nicht gen√ºgend historische Daten erhalten');
                    }
                    
                } catch (error) {
                    console.error('Alle APIs fehlgeschlagen:', error);
                    this.updateStatus('‚ö†Ô∏è APIs nicht verf√ºgbar - Bitte versuchen Sie es sp√§ter erneut', 'error');
                }
            }

            processYahooFinanceData(chartData) {
                const timestamps = chartData.timestamp;
                const prices = chartData.indicators.quote[0].close;
                
                console.log(`Verarbeite ${timestamps.length} Yahoo Finance Datenpunkte von ${new Date(timestamps[0] * 1000).toLocaleDateString()} bis ${new Date(timestamps[timestamps.length-1] * 1000).toLocaleDateString()}`);
                
                this.priceData = [];
                
                for (let i = 0; i < timestamps.length; i++) {
                    const date = new Date(timestamps[i] * 1000);
                    const price = prices[i];
                    
                    if (!price || price <= 0) continue; // Skip invalid data
                    
                    const dataPoint = { date, price };
                    
                    // Berechne Moving Averages
                    if (this.priceData.length >= 111) {
                        const slice111 = this.priceData.slice(-111);
                        dataPoint.ma111 = slice111.reduce((sum, item) => sum + item.price, 0) / 111;
                    }
                    if (this.priceData.length >= 350) {
                        const slice350 = this.priceData.slice(-350);
                        dataPoint.ma350x2 = (slice350.reduce((sum, item) => sum + item.price, 0) / 350) * 2;
                    }
                    
                    this.priceData.push(dataPoint);
                }
                
                this.updateCurrentValues();
                this.updateDisplay();
                this.updateChart();
            }

            processCryptoCompareData(data) {
                console.log(`Verarbeite ${data.length} CryptoCompare Datenpunkte von ${new Date(data[0].time * 1000).toLocaleDateString()} bis ${new Date(data[data.length-1].time * 1000).toLocaleDateString()}`);
                
                this.priceData = data.map((item, index) => {
                    const date = new Date(item.time * 1000);
                    const price = item.close;
                    const dataPoint = { date, price };
                    
                    // Berechne Moving Averages
                    if (index >= 111) {
                        const slice = data.slice(index - 110, index + 1);
                        dataPoint.ma111 = slice.reduce((sum, d) => sum + d.close, 0) / 111;
                    }
                    if (index >= 350) {
                        const slice = data.slice(index - 349, index + 1);
                        dataPoint.ma350x2 = (slice.reduce((sum, d) => sum + d.close, 0) / 350) * 2;
                    }
                    
                    return dataPoint;
                });
                
                this.updateCurrentValues();
                this.updateDisplay();
                this.updateChart();
            }

            updateCurrentValues() {
                if (this.priceData.length < 2) return;
                
                const latest = this.priceData[this.priceData.length - 1];
                const previous = this.priceData[this.priceData.length - 2];
                
                this.currentPrice = latest.price;
                this.priceChange24h = ((latest.price - previous.price) / previous.price) * 100;
                this.ma111 = latest.ma111;
                this.ma350x2 = latest.ma350x2;
                
                console.log(`Aktuelle Werte: BTC $${this.currentPrice?.toLocaleString()}, MA111: $${this.ma111?.toLocaleString()}, MA350x2: $${this.ma350x2?.toLocaleString()}`);
            }

            updateDisplay() {
                // Bitcoin Preis
                document.getElementById('bitcoinPrice').textContent = this.formatCurrency(this.currentPrice);
                
                // 24h Change
                const changeElement = document.getElementById('priceChange');
                if (this.priceChange24h !== undefined) {
                    const changeText = `${this.priceChange24h >= 0 ? '+' : ''}${this.priceChange24h.toFixed(2)}% (24h)`;
                    changeElement.textContent = changeText;
                    changeElement.className = `change ${this.priceChange24h >= 0 ? 'positive' : 'negative'}`;
                } else {
                    changeElement.textContent = '--';
                }
                
                // Moving Averages
                document.getElementById('ma111').textContent = this.ma111 ? this.formatCurrency(this.ma111) : '--';
                document.getElementById('ma350x2').textContent = this.ma350x2 ? this.formatCurrency(this.ma350x2) : '--';
                
                // Pi Cycle Signal
                this.updatePiCycleSignal();
                this.updateLastUpdateTime();
            }

            updatePiCycleSignal() {
                if (!this.ma111 || !this.ma350x2) {
                    document.getElementById('signalText').textContent = 'Berechne...';
                    document.getElementById('signalDistance').textContent = '--';
                    document.getElementById('dailyChange').textContent = '--';
                    return;
                }
                
                const ratio = this.ma111 / this.ma350x2;
                const distance = ((ratio - 1) * 100);
                
                // Berechne t√§gliche √Ñnderung
                const dailyChangeEl = document.getElementById('dailyChange');
                if (this.priceData.length >= 2) {
                    const yesterday = this.priceData[this.priceData.length - 2];
                    if (yesterday.ma111 && yesterday.ma350x2) {
                        const yesterdayRatio = yesterday.ma111 / yesterday.ma350x2;
                        const yesterdayDistance = ((yesterdayRatio - 1) * 100);
                        const dailyChange = distance - yesterdayDistance;
                        
                        const changeText = `${dailyChange >= 0 ? '+' : ''}${dailyChange.toFixed(3)}%`;
                        dailyChangeEl.textContent = changeText;
                        dailyChangeEl.style.color = dailyChange >= 0 ? '#f44336' : '#4caf50'; // Rot wenn n√§her am Top, Gr√ºn wenn weiter weg
                    } else {
                        dailyChangeEl.textContent = '--';
                    }
                } else {
                    dailyChangeEl.textContent = '--';
                }
                
                const indicator = document.getElementById('signalIndicator');
                const text = document.getElementById('signalText');
                const distanceEl = document.getElementById('signalDistance');
                
                distanceEl.textContent = `${distance.toFixed(1)}%`;
                
                if (ratio >= 1.0) {
                    indicator.className = 'signal-indicator bearish';
                    text.textContent = 'Pi Cycle Top erreicht!';
                } else if (ratio >= 0.95) {
                    indicator.className = 'signal-indicator warning';
                    text.textContent = 'Vorsicht - Ann√§herung';
                } else {
                    indicator.className = 'signal-indicator';
                    text.textContent = 'Normal';
                }
                
                console.log(`Pi Cycle Signal: Ratio ${ratio.toFixed(3)}, Distance ${distance.toFixed(1)}%, Status: ${text.textContent}`);
            }

            updateChart() {
                const ctx = document.getElementById('priceChart').getContext('2d');
                
                if (this.chart) {
                    this.chart.destroy();
                }
                
                const chartData = this.getChartData();
                
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#ccc',
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#333',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        return `${label}: ${value ? '$' + Math.round(value).toLocaleString() : '--'}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: '#333' },
                                ticks: { 
                                    color: '#ccc',
                                    maxTicksLimit: 10
                                }
                            },
                            y: {
                                type: 'logarithmic',
                                grid: { color: '#333' },
                                ticks: {
                                    color: '#ccc',
                                    callback: function(value) {
                                        return '$' + Math.round(value).toLocaleString();
                                    }
                                }
                            }
                        },
                        elements: {
                            point: {
                                radius: 0,
                                hoverRadius: 4
                            },
                            line: {
                                tension: 0.1
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
                
                console.log(`Chart aktualisiert mit ${chartData.labels.length} Datenpunkten`);
                
                // Rainbow Chart nach dem Hauptchart aktualisieren
                this.updateRainbowChart();
            }
            
            updateRainbowChart() {
                const ctx = document.getElementById('rainbowChart').getContext('2d');
                
                if (this.rainbowChart) {
                    this.rainbowChart.destroy();
                }
                
                const rainbowData = this.getRainbowChartData();
                
                this.rainbowChart = new Chart(ctx, {
                    type: 'line',
                    data: rainbowData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#ccc',
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#333',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        return `${label}: ${value ? '$' + Math.round(value).toLocaleString() : '--'}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: '#333' },
                                ticks: {
                                    color: '#ccc',
                                    maxTicksLimit: 10
                                }
                            },
                            y: {
                                type: 'logarithmic',
                                grid: { color: '#333' },
                                ticks: {
                                    color: '#ccc',
                                    callback: function(value) {
                                        return '$' + Math.round(value).toLocaleString();
                                    }
                                }
                            }
                        },
                        elements: {
                            point: {
                                radius: 0,
                                hoverRadius: 0
                            },
                            line: {
                                tension: 0.1
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
                
                console.log('Rainbow Chart aktualisiert');
            }
            
            getRainbowChartData() {
                if (this.priceData.length === 0) return { labels: [], datasets: [] };
                
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - this.currentPeriod);
                
                const filteredData = this.priceData.filter(item => item.date >= cutoffDate);
                
                // Zeitraum f√ºr die x-Achse
                const labels = filteredData.map(item => item.date.toLocaleDateString('de-DE'));
                
                // Bitcoin Preisdaten
                const bitcoinDataset = {
                    label: 'Bitcoin Preis',
                    data: filteredData.map(item => item.price),
                    borderColor: '#f7931a',
                    backgroundColor: 'rgba(247, 147, 26, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    zIndex: 10
                };
                
                // Rainbow-Bands erzeugen
                const bands = this.calculateRainbowBands(filteredData);
                
                return {
                    labels: labels,
                    datasets: [
                        // Regenbogen-B√§nder (von unten nach oben)
                        {
                            label: 'Extremer Ausverkauf',
                            data: bands.band1,
                            borderColor: 'rgba(0, 98, 255, 0.3)',
                            backgroundColor: 'rgba(0, 98, 255, 0.2)',
                            borderWidth: 1,
                            fill: '+1',
                            pointRadius: 0
                        },
                        {
                            label: '√úberverkauft',
                            data: bands.band2,
                            borderColor: 'rgba(0, 212, 255, 0.3)',
                            backgroundColor: 'rgba(0, 212, 255, 0.2)',
                            borderWidth: 1,
                            fill: '+1',
                            pointRadius: 0
                        },
                        {
                            label: 'Fair Value',
                            data: bands.band3,
                            borderColor: 'rgba(82, 255, 0, 0.3)',
                            backgroundColor: 'rgba(82, 255, 0, 0.2)',
                            borderWidth: 1,
                            fill: '+1',
                            pointRadius: 0
                        },
                        {
                            label: 'Sehr √ºberkauft',
                            data: bands.band4,
                            borderColor: 'rgba(255, 195, 0, 0.3)',
                            backgroundColor: 'rgba(255, 195, 0, 0.2)',
                            borderWidth: 1,
                            fill: '+1',
                            pointRadius: 0
                        },
                        {
                            label: 'FOMO √ºberkauft',
                            data: bands.band5,
                            borderColor: 'rgba(255, 97, 0, 0.3)',
                            backgroundColor: 'rgba(255, 97, 0, 0.2)',
                            borderWidth: 1,
                            fill: '+1',
                            pointRadius: 0
                        },
                        {
                            label: 'Maximale Blase',
                            data: bands.band6,
                            borderColor: 'rgba(255, 0, 0, 0.3)',
                            backgroundColor: 'rgba(255, 0, 0, 0.2)',
                            borderWidth: 1,
                            fill: '+1',
                            pointRadius: 0
                        },
                        // Bitcoin Price (on top of bands)
                        bitcoinDataset
                    ]
                };
            }
            
            calculateRainbowBands(data) {
                // Original Bitcoin Rainbow Chart Model
                // Basiert auf logarithmischer Regression seit Bitcoin-Start
                
                const bands = {
                    band1: [], // Unterstes Band (Extremer Ausverkauf)
                    band2: [], // √úberverkauft
                    band3: [], // Fair Value
                    band4: [], // Sehr √ºberkauft
                    band5: [], // FOMO √ºberkauft
                    band6: []  // Oberstes Band (Maximale Blase)
                };
                
                data.forEach((item, index) => {
                    // Berechne Tage seit Bitcoin-Genesis-Block (3. Januar 2009)
                    const btcStartDate = new Date('2009-01-03').getTime();
                    const daysSinceBtcStart = (item.date.getTime() - btcStartDate) / (1000 * 60 * 60 * 24);
                    
                    // Originale Rainbow Chart Formel (logarithmische Regression)
                    // y = 10^(a + b * log10(x))
                    // a und b sind Regressionsparameter
                    const a = -17.01593313;  // Intercept
                    const b = 5.82509775;    // Slope
                    
                    // Berechne die Mittellinie (Fair Value)
                    const logDays = Math.log10(daysSinceBtcStart);
                    const logPrice = a + b * logDays;
                    const fairValue = Math.pow(10, logPrice);
                    
                    // Rainbow-B√§nder mit spezifischen Multiplikatoren
                    // Diese Werte entsprechen den originalen Rainbow-Stufen
                    bands.band1.push(fairValue * 0.15);   // -85% (Extremer Ausverkauf)
                    bands.band2.push(fairValue * 0.35);   // -65% (√úberverkauft)
                    bands.band3.push(fairValue * 1.0);    // 0% (Fair Value)
                    bands.band4.push(fairValue * 2.8);    // +180% (Sehr √ºberkauft)
                    bands.band5.push(fairValue * 7.9);    // +690% (FOMO √ºberkauft)
                    bands.band6.push(fairValue * 22.4);   // +2140% (Maximale Blase)
                });
                
                return bands;
            }

            getChartData() {
                if (this.priceData.length === 0) return { labels: [], datasets: [] };
                
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - this.currentPeriod);
                
                const filteredData = this.priceData.filter(item => item.date >= cutoffDate);
                
                console.log(`Zeige ${filteredData.length} Datenpunkte f√ºr Zeitraum von ${filteredData[0]?.date.toLocaleDateString()} bis ${filteredData[filteredData.length-1]?.date.toLocaleDateString()}`);
                
                return {
                    labels: filteredData.map(item => item.date.toLocaleDateString('de-DE')),
                    datasets: [
                        {
                            label: 'Bitcoin Preis',
                            data: filteredData.map(item => item.price),
                            borderColor: '#f7931a',
                            backgroundColor: 'rgba(247, 147, 26, 0.1)',
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: '111-Tage MA',
                            data: filteredData.map(item => item.ma111),
                            borderColor: '#4caf50',
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: '350-Tage MA √ó 2',
                            data: filteredData.map(item => item.ma350x2),
                            borderColor: '#f44336',
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                };
            }

            updateLastUpdateTime() {
                const now = new Date();
                const timeString = now.toLocaleString('de-DE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let dataInfo = '';
                if (this.priceData.length > 0) {
                    const firstDate = this.priceData[0].date.toLocaleDateString('de-DE');
                    const lastDate = this.priceData[this.priceData.length - 1].date.toLocaleDateString('de-DE');
                    dataInfo = ` (${this.priceData.length} Tage: ${firstDate} - ${lastDate})`;
                }
                
                const prefix = this.isUsingLiveData ? 'Live-Daten geladen: ' : 'Daten generiert: ';
                document.getElementById('lastUpdate').textContent = prefix + timeString + dataInfo;
            }

            updateStatus(message, type = 'success') {
                const statusEl = document.getElementById('statusNotice');
                if (statusEl) {
                    statusEl.textContent = message;
                    statusEl.className = `status-notice ${type}`;
                }
            }

            formatCurrency(value) {
                if (!value) return '--';
                return '$' + Math.round(value).toLocaleString();
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }
            }
        }
        
        // Starte die App sofort wenn DOM geladen ist
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM geladen, starte Bitcoin Pi Cycle App...');
            try {
                new BitcoinPiCycleApp();
                
                // Registriere Service Worker f√ºr Offline-Funktionalit√§t
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => console.log('Service Worker registriert:', reg))
                        .catch(err => console.log('Service Worker Fehler:', err));
                }
            } catch (error) {
                console.error('Fehler beim Starten der App:', error);
                document.body.innerHTML = '<div style="color: white; text-align: center; padding: 50px;">Fehler beim Laden der App. Bitte laden Sie die Seite neu.</div>';
            }
        });
    </script>
</body>
</html>